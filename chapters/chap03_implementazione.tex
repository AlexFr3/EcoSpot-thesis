\chapter{Sviluppo e Implementazione}
\label{chap:implementation}

Questo capitolo descrive le fasi realizzative dell'applicazione \textit{EcoSpot}, analizzando l'architettura del software, le scelte tecniche per lo sviluppo mobile e l'implementazione delle funzionalità core come la mappa interattiva, il sistema di gamification e l'integrazione dei sensori IoT.

\section{Architettura del Progetto}
Il progetto è stato strutturato seguendo una divisione in layer logici per garantire manutenibilità e scalabilità del codice. La cartella sorgente (\texttt{lib}) è organizzata nei seguenti moduli principali:

\begin{itemize}
    \item \textbf{Data Layer}: Contiene le definizioni delle entità (es. \texttt{UserModel}, \texttt{Species}, \texttt{SensorData}) e la logica di persistenza dei dati.
    \item \textbf{Service Layer}: Gestisce la comunicazione con i servizi esterni. Qui risiedono \texttt{AuthService} per l'autenticazione, \texttt{SensorService} per i dati IoT e \texttt{WeatherService} per le API meteo.
    \item \textbf{Presentation Layer}: Comprende i widget dell'interfaccia utente (\texttt{pages} e \texttt{widgets}), separando la logica di visualizzazione dallo stato dell'applicazione.
\end{itemize}

\subsection{Sincronizzazione dati}
L'implementazione della logica reattiva si basa sull'utilizzo dei StreamProvider di Riverpod. Nel caso del tracciamento utente, il provider userPositionProvider sottoscrive lo stream di eventi del plugin Geolocator. Come mostrato nel Listing 3.1, il widget MapWidget consuma questo stato: ogni volta che il GPS rileva un movimento, il provider emette un nuovo oggetto Position, causando il rebuild parziale della sola componente mappa, senza intaccare il resto dell'interfaccia, ottimizzando così le risorse del dispositivo mobile...
% --- AGGIUNTA LA SEZIONE MANCANTE ---
\section{Sviluppo dell'Applicazione Mobile}
Lo sviluppo si è concentrato sulla creazione di un'esperienza utente fluida, sfruttando le capacità multi-piattaforma di Flutter.

\subsection{Mappa Interattiva e Clustering}
La visualizzazione cartografica è il punto centrale dell'interazione ed è gestita dal widget \texttt{MapWidget}, che integra la libreria \texttt{flutter\_map} \cite{fluttermap}. 

Per gestire l'elevato numero di marker (animali, piante, sensori) senza compromettere le prestazioni, è stato implementato un sistema di clustering tramite il pacchetto \texttt{flutter\_map\_marker\_cluster}. Questo permette di raggruppare visivamente i punti di interesse vicini quando lo zoom della mappa è basso.

Il seguente codice mostra come vengono renderizzati i marker per le aree verdi utilizzando i widget nativi di Flutter \cite{flutter}:

\begin{listing}[H]
\begin{minted}[frame=single, breaklines]{dart}
// Rendering dei marker sulla mappa (estratto da MapWidget)
...widget.greenAreas.map((area) {
  return Marker(
    point: area.centerPoint,
    width: 70,
    height: 70,
    child: GestureDetector(
      onTap: () {
        showModalBottomSheet(
          context: context,
          builder: (context) => GreenAreaDetailSheet(species: area),
        );
      },
      child: Image.asset(area.imagePath),
    ),
  );
})
\end{minted}
\caption{Rendering dei marker sulla mappa}
\label{lst:map_markers}
\end{listing}

\subsection{Gestione Gamification}
Il cuore dell'esperienza utente è il sistema di scoperta ("Discovery"), progettato per incentivare l'esplorazione fisica del Parco. L'app calcola costantemente la distanza geodetica tra la posizione dell'utente e quella delle specie target.

\subsubsection{Logica di Scoperta}
Quando la distanza rilevata è inferiore al parametro \texttt{discoveryRadius}, viene invocato il metodo \texttt{discoverSpecies} nel database helper. L'algoritmo è implementato in Dart \cite{dart} sfruttando la precisione del GPS del dispositivo mobile.

\begin{listing}[H]
  \begin{minted}[frame=single, breaklines]{dart}
void _checkDiscoveries(LatLng userLocation) {
  // Calcolo distanza geodetica
  final double meters = _distanceCalculator.as(
      LengthUnit.Meter, userLocation, species.centerPoint);

  // Verifica soglia di scoperta
  if (meters <= species.discoveryRadius) {
    _triggerDiscovery(user.uid, species);
  }
}
  \end{minted}
  \caption{Algoritmo di scoperta basato sulla distanza}
  \label{lst:discovery}
\end{listing}

\subsubsection{Utente e Rango}
Il modello utente (\texttt{UserModel}) calcola dinamicamente il livello e il rango (es. "Guardiano", "Leggenda") in base ai punti esperienza (XP) accumulati con le scoperte. Questo aggiornamento avviene in tempo reale, sbloccando nuovi badge e contenuti nell'interfaccia.

\subsubsection{Segnalazioni}
Gli utenti possono effettuare delle segnalazioni che verranno salvate nel database con immagine, posizione e una descrizione.

\subsection{Integrazione Sensori}
Per fornire un quadro dello stato ambientale del Parco, l'applicazione integra dati provenienti da stazioni di monitoraggio reali. Il servizio \texttt{SensorService} interroga l'API \cite{discover_er_api} ed effettua il parsing dei dati JSON ricevuti dalle stazioni (es. Bellocchio, Foce).

\begin{listing}[H]
  \begin{minted}[frame=single, breaklines]{dart}
final response = await http.post(Uri.parse(_apiUrl), ...);

if (response.statusCode == 200) {
  final decodedBody = jsonDecode(response.body);
  // Estrazione e normalizzazione valore sensore
  value = decodedBody['sensorValue'] ?? decodedBody['value'];
  return MapEntry(sensorName, value ?? "N/D");
}
  \end{minted}
  \caption{Parsing dei dati sensore}
  \label{lst:sensor_parsing}
\end{listing}

Questi dati vengono poi presentati all'utente cliccando sulle icone delle stazioni sulla mappa, fornendo parametri come temperatura, umidità o livelli idrometrici aggiornati.

\section{Interfaccia Utente}
L'interfaccia è stata costruita utilizzando i principi del Material Design. Le schermate principali includono:

\begin{itemize}
    \item \textbf{Home Dashboard}: Una panoramica che mostra il meteo locale (tramite \texttt{WeatherService}) e il progresso attuale dell'utente.
    \item \textbf{Schede di Dettaglio}: Implementate tramite \texttt{GreenAreaDetailSheet} e \texttt{SpeciesDetailSheet}, queste viste modali forniscono informazioni educative e multimediali senza far perdere all'utente il contesto della mappa.
    \item \textbf{Profilo e Statistiche}: Una sezione dedicata alla visualizzazione delle specie collezionate e del rango raggiunto.
\end{itemize}

\section{Gestione dello Stato}
Per gestire la reattività dell'applicazione, è stato utilizzato il framework \textbf{Riverpod}. Il file \texttt{app\_providers.dart} raccoglie le definizioni dei provider globali, permettendo ai widget di ascoltare i cambiamenti nei dati (come una nuova scoperta o l'aggiornamento dei sensori) e di ricostruirsi automaticamente solo quando necessario, ottimizzando le risorse del dispositivo.